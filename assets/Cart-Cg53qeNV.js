import{P as se,d as te,b as F,r as i,h as S,j as e,C as P,S as ae,B as g,R as H,e as I,F as c,i as $,M as C,k as ne,s as le,l as O}from"./index-_JLlfX1p.js";import{I as oe,Q as ie}from"./QuantityButton-B3D4I4Q6.js";import{C as d,f as x}from"./format-CqrGYAHp.js";import{L as R}from"./ListGroup-BdMkmBTg.js";const re=[{code:"",label:"Pilih promo tersedia"},{code:"FREESHIP",label:"Gratis Ongkir",description:"Bebas biaya kirim hingga $6.50"},{code:"SALE10",label:"Diskon 10%",description:"Potongan 10% untuk produk pilihan"},{code:"BUNDLE20",label:"Bundling Hemat $20",description:"Min. belanja $200"}],_=({onCartChange:j})=>{const{products:b,shops:v,isLoading:h,isError:Q,refetch:U}=te(),L=F(),[f,V]=i.useState(()=>S()),[r,k]=i.useState(()=>new Set(f.map(t=>t.productId))),[w,E]=i.useState({show:!1,productId:null,text:""}),[m,z]=i.useState(""),T=i.useCallback((t=!0)=>{const s=S();V(s),k(a=>{const n=new Set(s.map(N=>N.productId)),l=new Set([...a].filter(N=>n.has(N)));return(a.size===f.length&&f.length>0||a.size===0&&f.length===0)&&s.forEach(N=>{l.has(N.productId)||l.add(N.productId)}),l}),t&&j&&j(s)},[j,f.length]),p=i.useMemo(()=>f.map(t=>{const s=b.find(l=>l.id===t.productId);if(!s)return null;const a=v.find(l=>{var y;return l.id===(t.shopId??((y=s.shop)==null?void 0:y.id))})??s.shop,n=s.price-s.price*(s.discount_percentage/100);return{...t,product:s,shop:a,discountedPrice:n}}).filter(Boolean),[f,b,v]),B=i.useMemo(()=>{const t=new Map;return p.forEach(s=>{var n,l;const a=((n=s.shop)==null?void 0:n.id)??s.shopId??"unknown";t.has(a)||t.set(a,{shopId:a,shopName:((l=s.shop)==null?void 0:l.name)??"Unknown Vendor",items:[]}),t.get(a).items.push(s)}),Array.from(t.values())},[p]),D=r.size===p.length&&p.length>0,u=i.useMemo(()=>{const t=p.reduce((s,a)=>(r.has(a.productId)&&(s.items+=1,s.quantity+=a.quantity,s.originalTotal+=a.product.price*a.quantity,s.discountedTotal+=a.discountedPrice*a.quantity),s),{items:0,quantity:0,originalTotal:0,discountedTotal:0});return t.savings=t.originalTotal-t.discountedTotal,t},[p,r]),o=i.useMemo(()=>{let s=u.items===0||u.discountedTotal>=150?0:6.5,a=0,n="";switch(m){case"FREESHIP":s>0?(a=s,s=0,n="Gratis ongkir diterapkan."):n="Belanja di atas $150 sudah gratis ongkir.";break;case"SALE10":u.items>0&&(a=u.discountedTotal*.1,n="Diskon 10% berhasil diterapkan.");break;case"BUNDLE20":u.discountedTotal>=200?(a=20,n="Potongan bundling $20 diterapkan."):u.items>0&&(n="Minimal belanja $200 untuk promo bundling.");break}const l=Math.max(u.discountedTotal+s-a,0);return{...u,shipping:s,promoDiscount:a,finalTotal:l,promoMessage:n}},[u,m]);i.useEffect(()=>{o.items===0&&m&&z("")},[o.items,m]);const A=i.useCallback(()=>B.map(t=>{const s=t.items.filter(n=>r.has(n.productId));if(s.length===0)return null;const a=s.reduce((n,l)=>{const y=l.product.price*l.quantity,q=l.discountedPrice*l.quantity;return n.quantity+=l.quantity,n.subtotal+=y,n.discountedTotal+=q,n.savings+=y-q,n},{quantity:0,subtotal:0,discountedTotal:0,savings:0});return{shop:{id:t.shopId,name:t.shopName},items:s.map(n=>{var l;return{productId:n.productId,title:n.product.title,quantity:n.quantity,price:n.product.price,discountedPrice:n.discountedPrice,image:(l=n.product.images)==null?void 0:l[0],discount:n.product.discount_percentage}}),totals:a}}).filter(Boolean),[B,r]),J=i.useCallback(()=>{const t=A();if(!t.length)return;const s={groups:t,summary:o,promoCode:m||null,promoMessage:o.promoMessage,timestamp:new Date().toISOString()};localStorage.setItem("checkout_payload",JSON.stringify(s)),L("/checkout",{state:s})},[A,o,L,m]),K=()=>{k(D?new Set:new Set(p.map(t=>t.productId)))},W=t=>{if(t.items.every(a=>r.has(a.productId))){const a=new Set(r);t.items.forEach(n=>a.delete(n.productId)),k(a)}else{const a=new Set(r);t.items.forEach(n=>a.add(n.productId)),k(a)}},X=t=>{const s=new Set(r);s.has(t)?s.delete(t):s.add(t),k(s)},Y=t=>s=>{ne(t,s),T()},Z=t=>{$(t),T()},G=(t,s)=>{E({show:!0,productId:t,text:s??""})},M=()=>{E({show:!1,productId:null,text:""})},ee=()=>{w.productId&&(le(w.productId,w.text),M(),T())};return h?e.jsx(P,{className:"py-5 text-center",children:e.jsx(ae,{animation:"border",role:"status"})}):Q?e.jsxs(P,{className:"py-5 text-center d-flex flex-column align-items-center gap-3",children:[e.jsx("h2",{className:"h4 fw-bold mb-0",children:"Tidak dapat memuat detail produk"}),e.jsx("p",{className:"text-muted",children:"Periksa koneksi dan coba lagi."}),e.jsx(g,{onClick:U,children:"Muat ulang"})]}):p.length===0?null:e.jsxs(P,{as:"main",className:"py-5",children:[e.jsxs(H,{className:"g-4",children:[e.jsxs(I,{lg:8,children:[e.jsx(d,{className:"shadow-sm border-0 mb-4",children:e.jsxs(d.Body,{className:"d-flex justify-content-between align-items-center",children:[e.jsx(c.Check,{type:"checkbox",id:"select-all",label:`Pilih Semua (${o.quantity} item)`,checked:D,onChange:K}),r.size>0&&e.jsx(g,{variant:"outline-danger",size:"sm",onClick:()=>{r.forEach(t=>$(t)),T()},children:"Hapus Terpilih"})]})}),B.map(t=>e.jsxs(d,{className:"shadow-sm border-0 mb-4",children:[e.jsxs(d.Header,{className:"bg-white d-flex align-items-center justify-content-between",children:[e.jsx(c.Check,{type:"checkbox",id:`shop-${t.shopId}`,label:t.shopName,checked:t.items.every(s=>r.has(s.productId)),onChange:()=>W(t)}),e.jsxs("span",{className:"text-muted small",children:[t.items.length," produk"]})]}),e.jsx(R,{variant:"flush",children:t.items.map(s=>{var a;return e.jsx(R.Item,{className:"py-4",children:e.jsxs(H,{className:"align-items-center g-3",children:[e.jsx(I,{xs:"auto",children:e.jsx(c.Check,{type:"checkbox",checked:r.has(s.productId),onChange:()=>X(s.productId),"aria-label":`Pilih ${s.product.title}`})}),e.jsx(I,{sm:2,xs:3,children:e.jsx(oe,{src:(a=s.product.images)==null?void 0:a[0],alt:s.product.title,className:"img-fluid rounded",loading:"lazy",decoding:"async"})}),e.jsxs(I,{children:[e.jsx("h6",{className:"mb-1",children:s.product.title}),e.jsxs("div",{className:"d-flex flex-wrap align-items-center gap-3",children:[e.jsx("span",{className:"fw-semibold text-primary",children:x(s.discountedPrice)}),e.jsx("span",{className:"text-muted text-decoration-line-through",children:x(s.product.price)}),e.jsxs("span",{className:"badge bg-warning text-dark",children:[s.product.discount_percentage,"% OFF"]})]})]}),e.jsx(I,{sm:"auto",className:"text-sm-end",children:e.jsxs("div",{className:"d-flex flex-column align-items-sm-end gap-2",children:[e.jsx(ie,{productId:s.productId,value:s.quantity,persist:!1,onQuantityChange:Y(s.productId)}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[e.jsx(g,{variant:"link",size:"sm",className:"text-decoration-none p-0",onClick:()=>G(s.productId,s.note),children:s.note?"Edit Catatan":"Tambah Catatan"}),e.jsx(g,{variant:"link",size:"sm",className:"text-danger text-decoration-none p-0",onClick:()=>Z(s.productId),children:"Hapus"})]})]})})]})},s.productId)})})]},t.shopId))]}),e.jsx(I,{lg:4,children:e.jsx(d,{className:"shadow-sm border-0 sticky-top",style:{top:"6rem"},children:e.jsxs(d.Body,{children:[e.jsx("h5",{className:"mb-3",children:"Ringkasan Belanja"}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Produk dipilih"}),e.jsxs("span",{children:[o.items," produk (",o.quantity," pcs)"]})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Total Harga"}),e.jsx("span",{children:x(o.originalTotal)})]}),e.jsxs("div",{className:"d-flex justify-content-between text-success mb-2",children:[e.jsx("span",{children:"Hemat"}),e.jsxs("span",{children:["-",x(o.savings)]})]}),e.jsxs(c.Group,{className:"mb-3",children:[e.jsx(c.Label,{className:"small text-muted mb-1",children:"Voucher & Promo"}),e.jsx(c.Select,{size:"sm",value:m,onChange:t=>z(t.target.value),disabled:o.items===0,children:re.map(t=>e.jsx("option",{value:t.code,children:t.label},t.code||"default"))}),m&&o.promoMessage&&e.jsx("div",{className:"small text-muted mt-2",children:o.promoMessage})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:x(o.discountedTotal)})]}),e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsx("span",{children:"Ongkir"}),e.jsx("span",{children:o.shipping===0?"Gratis":x(o.shipping)})]}),e.jsxs("div",{className:"d-flex justify-content-between text-success mb-2",children:[e.jsx("span",{children:"Promo"}),e.jsx("span",{children:o.promoDiscount>0?`-${x(o.promoDiscount)}`:"-"})]}),e.jsx(d,{className:"bg-light border-0 mb-3",children:e.jsxs(d.Body,{className:"d-flex justify-content-between align-items-center",children:[e.jsx("span",{className:"fw-semibold",children:"Total Bayar"}),e.jsx("span",{className:"fs-5 fw-bold text-primary",children:x(o.finalTotal)})]})}),e.jsx(g,{variant:"primary",className:"w-100",size:"lg",disabled:o.items===0,onClick:J,children:"Lanjutkan Pembayaran"})]})})})]}),e.jsxs(C,{show:w.show,onHide:M,centered:!0,children:[e.jsx(C.Header,{closeButton:!0,children:e.jsx(C.Title,{children:"Catatan Produk"})}),e.jsx(C.Body,{children:e.jsxs(c.Group,{controlId:"note",children:[e.jsx(c.Label,{children:"Keterangan untuk penjual"}),e.jsx(c.Control,{as:"textarea",rows:4,value:w.text,onChange:t=>E(s=>({...s,text:t.target.value})),maxLength:200}),e.jsx(c.Text,{muted:!0,children:"Max 200 karakter."})]})}),e.jsxs(C.Footer,{children:[e.jsx(g,{variant:"outline-secondary",onClick:M,children:"Batal"}),e.jsx(g,{variant:"primary",onClick:ee,children:"Simpan Catatan"})]})]})]})};_.propTypes={onCartChange:se.func};const de=()=>{const j=F();return e.jsx(P,{className:"py-5",children:e.jsx(d,{className:"border-0 shadow-sm text-center py-5",children:e.jsxs(d.Body,{className:"d-flex flex-column gap-3 align-items-center",children:[e.jsx(d.Title,{className:"fs-3 fw-bold",children:"Keranjang belanja kamu masih kosong"}),e.jsx(d.Text,{className:"text-muted",children:"Jelajahi koleksi produk kami dan temukan perangkat favoritmu."}),e.jsx(g,{size:"lg",onClick:()=>j("/"),children:"Mulai Belanja"})]})})})},pe=()=>{const[j,b]=i.useState(()=>S());i.useEffect(()=>{b(S())},[]),i.useEffect(()=>{const h=()=>b(S());return window.addEventListener(O,h),window.addEventListener("storage",h),()=>{window.removeEventListener(O,h),window.removeEventListener("storage",h)}},[]);const v=i.useCallback(h=>{b(h)},[]);return j.length===0?e.jsx(de,{}):e.jsx(_,{onCartChange:v})};export{pe as default};
